/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
define(["ojs/ojcore","jquery","knockout","ojs/ojarraydataprovider","ojs/ojeventtarget","ojs/ojtreedataprovider"],function(e,t,r){"use strict";e.ArrayDataProvider;class a{constructor(t,r,a){this.treeData=t,this.options=r,this._rootDataProvider=a,this.TreeAsyncIterator=class{constructor(e,t){this._parent=e,this._baseIterable=t}next(){let e=this;return this._baseIterable[Symbol.asyncIterator]().next().then(function(t){let r=t.value.metadata;for(let a=0;a<r.length;a++)r[a]=e._parent._getNodeMetadata(t.value.data[a]);return t})}},this.TreeAsyncIterable=class{constructor(e,t){this._parent=e,this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},this._baseDataProvider=new e.ArrayDataProvider(t,r),this._mapKeyToNode=new Map,this._mapNodeToKey=new Map,this._mapArrayToSequenceNum=new Map,this._mapKoArrayToSubscriptions=new Map,null==a&&this._processTreeArray(t,[])}containsKeys(e){return this.fetchByKeys(e).then(function(t){let r=new Set;return e.keys.forEach(function(e){null!=t.results.get(e)&&r.add(e)}),Promise.resolve({containsParameters:e,results:r})})}getCapability(e){return this._baseDataProvider.getCapability(e)}getTotalSize(){return this._baseDataProvider.getTotalSize()}isEmpty(){return this._baseDataProvider.isEmpty()}getChildDataProvider(e,t){let r=this._getNodeForKey(e);if(r){let e=this._getChildren(r);if(e){return new a(e,this.options,this._getRootDataProvider())}}return null}fetchFirst(e){if(e&&e.filterCriterion){let r=t.extend({},e);r.filterCriterion=this._getLeafNodeFilter(r.filterCriterion),r.filterCriterion.filter=e.filterCriterion.filter,e=r}let r=this._baseDataProvider.fetchFirst(e);return new this.TreeAsyncIterable(this,new this.TreeAsyncIterator(this,r))}fetchByOffset(e){let t=this._baseDataProvider.fetchByOffset(e),r=this;return t.then(function(e){let t=e.results,a=[];for(let e=0;e<t.length;e++){let s=t[e].metadata,i=t[e].data;s=r._getNodeMetadata(i),a.push({data:i,metadata:s})}return{done:e.done,fetchParameters:e.fetchParameters,results:a}})}fetchByKeys(e){let t=this,r=new Map;return e.keys.forEach(function(e){let a=t._getNodeForKey(e);a&&r.set(e,{metadata:{key:e},data:a})}),Promise.resolve({fetchParameters:e,results:r})}_getChildren(e){let t=this.options&&this.options.childrenAttribute?this.options.childrenAttribute:"children";return this._getVal(e,t,!0)}_getRootDataProvider(){return this._rootDataProvider?this._rootDataProvider:this}_subscribeObservableArray(t,a){if(!r.isObservable(t)||void 0===t.destroyAll)throw new Error("Invalid data type. ArrayTreeDataProvider only supports Array or observableArray.");var s=this,i=null,n=new Array(2);n[0]=t.subscribe(function(r){let n,o,l,u=[],d=[],h=[],y=[],p=[],c=null,_=null,f=null,g=[];for(n=0;n<r.length;n++){l=r[n].index,status=r[n].status;let t=s._getId(r[n].value);if(t)for(o=0;o<r.length;o++)if(o!=n&&l===r[o].index&&status!==r[o].status&&p.indexOf(n)<0&&g.indexOf(n)<0){let a=s._getId(r[o].value);e.Object.compareValues(t,a)&&("deleted"===status?(g.push(n),p.push(o)):(g.push(o),p.push(n)))}}for(n=0;n<r.length;n++)if("deleted"===r[n].status&&p.indexOf(n)<0&&g.indexOf(n)<0){let e=r[n].value,t=s._getKeyForNode(e);d.push(t),u.push(e),h.push(r[n].index),s._releaseNode(e)}if(d.length>0){y=d.map(function(e){return{key:e}});let e=new Set;d.map(function(t){e.add(t)}),f={data:u,indexes:h,keys:e,metadata:y}}u=[],d=[],h=[],y=[];let b=t(),v=[],m=[],A=[],N=[];for(n=0;n<r.length;n++)if("added"===r[n].status&&g.indexOf(n)<0){let e=r[n].value,i=s._processNode(e,a,t);p.indexOf(n)<0?(d.push(i.key),u.push(e),h.push(r[n].index),y.push({key:i.key})):(v.push(i.key),m.push(e),A.push(r[n].index),N.push({key:i.key}))}if(d.length>0){let e=new Set;d.map(function(t){e.add(t)});let t,r=new Set,i=[],n=[];t=s.options&&s.options.keyAttributes&&"siblings"!==s.options.keyAttributesScope?a.length>0?a[a.length-1]:null:a.length>0?a:null,h.map(function(e){let a;a=e>=b.length-1?"":s._getKeyForNode(b[e+1]),r.add(a),i.push(a),n.push(t)}),_={afterKeys:r,addBeforeKeys:i,parentKeys:n,data:u,indexes:h,keys:e,metadata:y}}if(v.length>0){let e=new Set;v.map(function(t){e.add(t)}),c={data:m,indexes:A,keys:e,metadata:N}}i=new e.DataProviderMutationEvent({add:_,remove:f,update:c})},null,"arrayChange"),n[1]=t.subscribe(function(t){i?s.dispatchEvent(i):s.dispatchEvent(new e.DataProviderRefreshEvent),i=null},null,"change"),this._mapKoArrayToSubscriptions.set(t,n)}_unsubscribeObservableArray(e){if(r.isObservable(e)&&void 0!==e.destroyAll){var t=this._mapKoArrayToSubscriptions.get(e);t&&(t[0].dispose(),t[1].dispose(),this._mapKoArrayToSubscriptions.delete(e))}}_processTreeArray(e,t){let r,a=this;e instanceof Array?r=e:(this._subscribeObservableArray(e,t),r=e()),r.forEach(function(r,s){a._processNode(r,t,e)})}_releaseTreeArray(e){let t,r=this;e instanceof Array?t=e:(this._unsubscribeObservableArray(e),t=e()),t.forEach(function(e,t){r._releaseNode(e)})}_processNode(e,t,r){let a=this,s=a._createKeyObj(e,t,r);a._setMapEntry(s.key,e);let i=a._getChildren(e);return i&&a._processTreeArray(i,s.keyPath),s}_releaseNode(e){let t=this,r=this._getKeyForNode(e);t._deleteMapEntry(r,e);let a=t._getChildren(e);a&&t._releaseTreeArray(a)}_createKeyObj(e,t,r){let a=this._getId(e),s=t?t.slice():[];return null==a?(s.push(this._incrementSequenceNum(r)),a=s):(s.push(a),this.options&&"siblings"==this.options.keyAttributesScope&&(a=s)),{key:a,keyPath:s}}_getId(e){let t,r=null!=this.options?this.options.keyAttributes:null;if(null!=r){var a;if(Array.isArray(r))for(t=[],a=0;a<r.length;a++)t[a]=this._getVal(e,r[a]);else t="@value"==r?this._getAllVals(e):this._getVal(e,r);return t}return null}_getVal(e,t,r){if("string"==typeof t){let r=t.indexOf(".");if(r>0){let a=t.substring(0,r),s=t.substring(r+1),i=e[a];if(i)return this._getVal(i,s)}}return!0!==r&&"function"==typeof e[t]?e[t]():e[t]}_getAllVals(e){let t=this;return Object.keys(e).map(function(r){return t._getVal(e,r)})}_getNodeMetadata(e){return{key:this._getKeyForNode(e)}}_getNodeForKey(e){return this._getRootDataProvider()._mapKeyToNode.get(JSON.stringify(e))}_getKeyForNode(e){return this._getRootDataProvider()._mapNodeToKey.get(e)}_setMapEntry(e,t){let r=this._getRootDataProvider();r._mapKeyToNode.set(JSON.stringify(e),t),r._mapNodeToKey.set(t,e)}_deleteMapEntry(e,t){let r=this._getRootDataProvider();r._mapKeyToNode.delete(JSON.stringify(e)),r._mapNodeToKey.delete(t)}_incrementSequenceNum(e){let t=this._getRootDataProvider(),r=t._mapArrayToSequenceNum.get(e)||0;return t._mapArrayToSequenceNum.set(e,r+1),r}_getLeafNodeFilter(e){let t;if(e&&e.text){t={op:"$regex",attribute:"*",value:new RegExp(e.text,"i")}}else t=e;let r=this.options&&this.options.childrenAttribute?this.options.childrenAttribute:"children";return{op:"$or",criteria:[t,{op:"$and",criteria:[{op:"$ne",attribute:r,value:null},{op:"$ne",attribute:r,value:void 0}]}]}}}
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
return e.ArrayTreeDataProvider=a,e.ArrayTreeDataProvider=a,e.EventTargetMixin.applyMixin(a),a});