/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovideradapter-base"],function(e,t,n){"use strict";function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function s(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l=function(t){function a(e){var t;return r(this,a),(t=s(this,o(a).call(this,e))).tableDataSource=e,t.FetchByKeysResults=function(){return function e(t,n,i){r(this,e),this._parent=t,this.fetchParameters=n,this.results=i,this[a._FETCHPARAMETERS]=n,this[a._RESULTS]=i}}(),t.ContainsKeysResults=function(){return function e(t,n,i){r(this,e),this._parent=t,this.containsParameters=n,this.results=i,this[a._CONTAINSPARAMETERS]=n,this[a._RESULTS]=i}}(),t.Item=function(){return function e(t,n,i){r(this,e),this._parent=t,this.metadata=n,this.data=i,this[a._METADATA]=n,this[a._DATA]=i}}(),t.FetchByOffsetResults=function(){return function e(t,n,i,s){r(this,e),this._parent=t,this.fetchParameters=n,this.results=i,this.done=s,this[a._FETCHPARAMETERS]=n,this[a._RESULTS]=i,this[a._DONE]=s}}(),t.FetchListParameters=function(){return function e(t,n,i){r(this,e),this._parent=t,this.size=n,this.sortCriteria=i,this[a._SIZE]=n,this[a._SORTCRITERIA]=i}}(),t._addTableDataSourceEventListeners(),t[a._OFFSET]=0,t._ignoreDataSourceEvents=new Array,t}var l,c,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(a,n),l=a,(c=[{key:"destroy",value:function(){this._removeTableDataSourceEventListeners()}},{key:"containsKeys",value:function(e){var t=this,n=[];return e[a._KEYS].forEach(function(e){n.push(t.tableDataSource.get(e))}),Promise.all(n).then(function(n){var r=new Set;return n.map(function(e){null!=e&&r.add(e[a._KEY])}),Promise.resolve(new t.ContainsKeysResults(t,e,r))})}},{key:"fetchByKeys",value:function(e){var t=this,n=[];return e[a._KEYS].forEach(function(e){n.push(t.tableDataSource.get(e))}),Promise.all(n).then(function(n){var r=new Map;return n.map(function(e){if(null!=e){var n=e[a._KEY],i=e[a._DATA];r.set(n,new t.Item(t,new t.ItemMetadata(t,n),i))}}),Promise.resolve(new t.FetchByKeysResults(t,e,r))})}},{key:"fetchByOffset",value:function(e){var t=this,n=null!=e?e[a._SIZE]:-1,r=null!=e?e[a._SORTCRITERIA]:null,i=null!=e&&e[a._OFFSET]>0?e[a._OFFSET]:0,s=new this.FetchListParameters(this,n,r);return this._startIndex=0,this._getFetchFunc(s,i)(s,!0).then(function(n){var r=n[a._VALUE],i=n[a._DONE],s=r[a._DATA],o=r[a._METADATA].map(function(e){return e[a._KEY]}),u=new Array;return s.map(function(e,n){u.push(new t.Item(t,new t.ItemMetadata(t,o[n]),s[n]))}),new t.FetchByOffsetResults(t,e,u,i)})}},{key:"fetchFirst",value:function(e){return this._isPagingModelTableDataSource()||(this._startIndex=0),new this.AsyncIterable(new this.AsyncIterator(this._getFetchFunc(e),e))}},{key:"getCapability",value:function(e){return e==a._SORT&&"full"==this.tableDataSource.getCapability(e)?{attributes:"multiple"}:"fetchByKeys"==e?{implementation:"lookup"}:"fetchByOffset"==e?{implementation:"lookup"}:null}},{key:"getTotalSize",value:function(){return Promise.resolve(this.tableDataSource.totalSize())}},{key:"isEmpty",value:function(){return this.tableDataSource.totalSize()>0?"no":"yes"}},{key:"getPage",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPage():-1}},{key:"setPage",value:function(e,t){return this._isPagingModelTableDataSource()?this.tableDataSource.setPage(e,t):Promise.reject(null)}},{key:"getStartItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getStartItemIndex():-1}},{key:"getEndItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getEndItemIndex():-1}},{key:"getPageCount",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPageCount():-1}},{key:"totalSize",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSize():-1}},{key:"totalSizeConfidence",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSizeConfidence():null}},{key:"_getFetchFunc",value:function(e,t){var n=this;if(null!=e&&null!=e[a._SORTCRITERIA]){var r=e[a._SORTCRITERIA][0][a._ATTRIBUTE],i=e[a._SORTCRITERIA][0][a._DIRECTION];return this._ignoreSortEvent=!0,this._isPagingModelTableDataSource()||(this._startIndex=0),function(e,r){return function(i,s){if(s){var o={};return o[a._KEY]=e,o[a._DIRECTION]=r,n[a._OFFSET]=0,n.tableDataSource.sort(o).then(function(){return n._ignoreSortEvent=!1,n._getTableDataSourceFetch(i,t)(i)})}return n._getTableDataSourceFetch(i,t)(i)}}(r,i)}return this._getTableDataSourceFetch(e,t)}},{key:"_getTableDataSourceFetch",value:function(e,t){var n=this;return function(e,r){var i={};if(t=t>0?t:0,null!=n._startIndex&&(i[a._STARTINDEX]=n._startIndex+t),i[a._PAGESIZE]=null!=e&&e[a._SIZE]>0?e[a._SIZE]:null,!n._isPagingModelTableDataSource()&&e[a._SILENT]&&(i[a._SILENT]=e[a._SILENT]),null!=n.tableDataSource[a._SORTCRITERIA]&&null==e[a._SORTCRITERIA]){e[a._SORTCRITERIA]=[];var s=new n.SortCriterion(n,n.tableDataSource[a._SORTCRITERIA][a._KEY],n.tableDataSource[a._SORTCRITERIA][a._DIRECTION]);e[a._SORTCRITERIA].push(s)}return i[a._FETCHTYPE]=e[a._FETCHTYPE],n._isFetching=!0,new Promise(function(t,r){n._fetchResolveFunc=t,n._fetchRejectFunc=r,n._fetchParams=e,n._requestEventTriggered||(n._isPagingModelTableDataSource()||i[a._SILENT]||n._ignoreDataSourceEvents.push(!0),n.tableDataSource.fetch(i).then(function(r){if(n._isPagingModelTableDataSource()||i[a._SILENT]||n._ignoreDataSourceEvents.pop(),null!==r){n._isFetching=!1,void 0===r&&((r={})[a._KEYS]=[],r[a._DATA]=[]);var s=[];null!=r[a._KEYS]&&(s=r[a._KEYS].map(function(e){return new n.ItemMetadata(n,e)})),null==n._startIndex&&(n._startIndex=0);var o=!1;n._startIndex=n._startIndex+r[a._DATA].length,"actual"==n.tableDataSource.totalSizeConfidence()&&n.tableDataSource.totalSize()>0&&r.startIndex+r[a._DATA].length>=n.tableDataSource.totalSize()?o=!0:i[a._PAGESIZE]>0&&r[a._DATA].length<i[a._PAGESIZE]?o=!0:0==r[a._DATA].length&&(o=!0),n._fetchResolveFunc=null,n._fetchParams=null,t(o?new n.AsyncIteratorReturnResult(n,new n.FetchListResult(n,e,r[a._DATA],s)):new n.AsyncIteratorYieldResult(n,new n.FetchListResult(n,e,r[a._DATA],s)))}},function(e){n._isPagingModelTableDataSource()||i[a._SILENT]||n._ignoreDataSourceEvents.pop(),r(e)}))})}}},{key:"_handleSync",value:function(t){var n=this;if(!(n._ignoreDataSourceEvents.length>0)){if(n._startIndex=null,t[a._STARTINDEX]>0&&(n._startIndex=t[a._STARTINDEX],n[a._OFFSET]=n._startIndex),n._fetchResolveFunc&&null!=t[a._KEYS]){n._isFetching=!1;var r=t[a._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),i=!1;"actual"==n.tableDataSource.totalSizeConfidence()&&n.tableDataSource.totalSize()>0&&n._startIndex+t[a._DATA].length>=n.tableDataSource.totalSize()&&(i=!0),i?n._fetchResolveFunc(new n.AsyncIteratorReturnResult(n,new n.FetchListResult(n,n._fetchParams,t[a._DATA],r))):n._fetchResolveFunc(new n.AsyncIteratorYieldResult(n,new n.FetchListResult(n,n._fetchParams,t[a._DATA],r))),n._fetchResolveFunc=null,n._fetchParams=null}else n._requestEventTriggered||n.dispatchEvent(new e.DataProviderRefreshEvent);n._requestEventTriggered=!1}}},{key:"_handleAdd",value:function(t){var n=this,r=t[a._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),i=new Set;t[a._KEYS].map(function(e){i.add(e)});var s=new n.DataProviderAddOperationEventDetail(n,i,null,null,null,r,t[a._DATA],t[a._INDEXES]),o=new n.DataProviderMutationEventDetail(n,s,null,null);n.dispatchEvent(new e.DataProviderMutationEvent(o))}},{key:"_handleRemove",value:function(t){var n=this,r=t[a._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),i=new Set;t[a._KEYS].map(function(e){i.add(e)});var s=new n.DataProviderOperationEventDetail(n,i,r,t[a._DATA],t[a._INDEXES]),o=new n.DataProviderMutationEventDetail(n,null,s,null);n.dispatchEvent(new e.DataProviderMutationEvent(o))}},{key:"_handleReset",value:function(t){this._requestEventTriggered||this._isPagingModelTableDataSource()||(this._startIndex=0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleSort",value:function(t){this._ignoreSortEvent||(this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleChange",value:function(t){var n=this,r=t[a._KEYS].map(function(e){return new n.ItemMetadata(n,e)}),i=new Set;t[a._KEYS].map(function(e){i.add(e)});var s=new n.DataProviderOperationEventDetail(n,i,r,t[a._DATA],t[a._INDEXES]),o=new n.DataProviderMutationEventDetail(n,null,null,s);n.dispatchEvent(new e.DataProviderMutationEvent(o))}},{key:"_handleRefresh",value:function(t){this._isFetching||this._requestEventTriggered||(null!=t[a._OFFSET]?this._startIndex=t[a._OFFSET]:this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent)),this._requestEventTriggered=!1}},{key:"_handleRequest",value:function(t){this._ignoreDataSourceEvents.length>0||void 0!==e.Model&&t instanceof e.Model||this._isFetching||(t[a._STARTINDEX]>0&&0==this.getStartItemIndex()&&(this._startIndex=t[a._STARTINDEX]),this._requestEventTriggered=!0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleError",value:function(e){this._fetchRejectFunc&&this._fetchRejectFunc(e),this._isFetching=!1,this._requestEventTriggered=!1}},{key:"_handlePage",value:function(t){this._isFetching=!1,this._requestEventTriggered=!1;var n={};n.detail=t,this.dispatchEvent(new e.GenericEvent(e.PagingModel.EventType.PAGE,n))}},{key:"_addTableDataSourceEventListeners",value:function(){this.removeAllListeners(),this.addListener("sync",this._handleSync),this.addListener("add",this._handleAdd),this.addListener("remove",this._handleRemove),this.addListener("reset",this._handleReset),this.addListener("sort",this._handleSort),this.addListener("change",this._handleChange),this.addListener("refresh",this._handleRefresh),this.addListener("request",this._handleRequest),this.addListener("error",this._handleError),this.addListener("page",this._handlePage)}},{key:"_removeTableDataSourceEventListeners",value:function(){this.removeListener("sync"),this.removeListener("add"),this.removeListener("remove"),this.removeListener("reset"),this.removeListener("sort"),this.removeListener("change"),this.removeListener("refresh"),this.removeListener("request"),this.removeListener("error"),this.removeListener("page")}},{key:"_isPagingModelTableDataSource",value:function(){return null!=this.tableDataSource.getStartItemIndex}}])&&i(l.prototype,c),h&&i(l,h),a}();l._STARTINDEX="startIndex",l._SILENT="silent",l._SORTCRITERIA="sortCriteria",l._PAGESIZE="pageSize",l._OFFSET="offset",l._SIZE="size",l._CONTAINSPARAMETERS="containsParameters",l._RESULTS="results",l._FETCHTYPE="fetchType",e.EventTargetMixin.applyMixin(l),e.TableDataSourceAdapter=l,e.TableDataSourceAdapter=l});