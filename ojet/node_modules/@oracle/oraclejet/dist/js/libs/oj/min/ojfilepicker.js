/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojtranslation","knockout","ojs/ojcomposite","ojs/ojlogger","ojs/ojcomponentcore","ojs/ojknockout"],function(e,t,r,n,i,o){"use strict";var a={properties:{accept:{type:"Array<string>"},disabled:{type:"boolean",value:!1},selectOn:{type:"string",enumValues:["auto","click","clickAndDrop","drop"],value:"auto"},selectionMode:{type:"string",enumValues:["multiple","single"],value:"multiple"}},methods:{setProperty:{},getProperty:{},setProperties:{},getNodeBySubId:{},getSubIdByNode:{}},events:{ojSelect:{},ojBeforeSelect:{},ojInvalidSelect:{}},extension:{}};a.extension._SHOULD_REMOVE_DISABLED=!0,i.register("oj-file-picker",{view:"<input type='file' class='oj-helper-hidden'       :multiple=\"[[$properties.selectionMode == 'multiple']]\"       :accept=\"[[acceptStr]]\"></input><div class='oj-filepicker-clickable'>  <oj-bind-slot name='trigger'>   <div tabindex='0'         :class=\"[[{'oj-filepicker-dropzone':$properties.disabled !== true, 'oj-filepicker-disabled': $properties.disabled === true}]]\">     <div class='oj-filepicker-text-parent'>       <div class='oj-filepicker-text'><oj-bind-text value='[[defPrimaryDropzoneText]]'></oj-bind-text></div>       <div class='oj-filepicker-secondary-text oj-typography-body-3'><oj-bind-text value='[[defSecondaryDropzoneText]]'></oj-bind-text></div>     </div><div class='oj-filepicker-icon oj-fwk-icon-plus oj-fwk-icon'></div></div>  </oj-bind-slot></div>",viewModel:function(i){var o,a,l,s,d,c,p=this,u=i.element,v=i.properties,f=!1,g=v.disabled,j=v.selectOn;function m(e){j=e;var r=o[0],n=t(u).find(".oj-filepicker-clickable")[0];if(function(e){e&&(e.removeEventListener("dragenter",L,!1),e.removeEventListener("dragover",A,!1),e.removeEventListener("dragleave",x,!1),e.removeEventListener("dragend",x,!1),e.removeEventListener("drop",D,!1))}(r),function(e){e&&(e.removeEventListener("click",y,!1),e.removeEventListener("keypress",y,!1))}(n),!g)switch(j){case"click":b(n);break;case"drop":T(r),n&&n.addEventListener("keypress",y,!1);break;case"auto":case"clickAndDrop":default:b(n),T(r)}}function h(e){g=e,m(j),"click"!==j&&(e?a.removeAttr("tabindex"):a.attr("tabindex",0))}function y(e){return("click"===e.type||"keypress"===e.type&&13===e.keyCode)&&(f=!0,e.preventDefault(),d.value=null,d.click(),!0)}function E(t){t.preventDefault(),t.stopPropagation();var r=t.target.files;if(r.length>0)if(e.AgentUtils.getAgentInfo().browser===e.AgentUtils.BROWSER.EDGE){var n=S(r).rejected;n.length>0?U(F(n),t,!1):C(r,t)}else C(r,t);f=!1}function k(t){var r,n=v.accept;if(!n||0===n.length||!t)return!0;for(var i=0;i<n.length;i++){if(!(r=e.StringUtils.trim(n[i])))return!0;if(r.startsWith(".",0)){if(!t.name||t.name&&t.name.endsWith(r))return!0}else{if(!t.type)return!1;if("image/*"===r){if(t.type.startsWith("image/",0))return!0}else if("video/*"===r){if(t.type.startsWith("video/",0))return!0}else if("audio/*"===r){if(t.type.startsWith("audio/",0))return!0}else if(t.type===r)return!0}}return!1}function S(e){var t,r=[],n=[],i=p.defUnknownFileType;if(e)for(var o=0;o<e.length;o++){var a=(t=e[o]).name;if(a){var l=a.split(".");i=l.length>1?"."+l.pop():i}i=t.type?t.type:i,r.includes(i)||n.includes(i)||(k(t)?r.push(i):n.push(i))}return{accepted:r,rejected:n}}function b(e){e&&(e.addEventListener("click",y,!1),e.addEventListener("keypress",y,!1))}function T(e){e&&(e.addEventListener("dragenter",L,!1),e.addEventListener("dragover",A,!1),e.addEventListener("dragleave",x,!1),e.addEventListener("dragend",x,!1),e.addEventListener("drop",D,!1))}function L(e){e.preventDefault(),e.stopPropagation()}function A(t){t.preventDefault(),t.stopPropagation();var r=t.dataTransfer;if(!l){var n=e.AgentUtils.getAgentInfo();if(l=!0,s=!0,n.browser!==e.AgentUtils.BROWSER.SAFARI&&n.browser!==e.AgentUtils.BROWSER.IE){var i=r.items,o=[],d=P(i),c=S(i);d&&0===c.rejected.length?a.addClass("oj-valid-drop"):(s=!1,d?o=F(c.rejected):o.push({severity:"error",summary:p.defSingleFileUploadError}),U(o,t,!0))}else a.addClass("oj-valid-drop")}}function P(e){return"single"!==u.selectionMode||1===e.length}function x(e){l&&(e.preventDefault(),e.stopPropagation(),0===t(e.relatedTarget).parents(".oj-filepicker").length&&(l=!1,a.removeClass("oj-valid-drop"),s||(c(),c=null,a.removeClass("oj-invalid-drop"))))}function D(t){if(l){t.preventDefault(),t.stopPropagation();var r=w(t.dataTransfer.files),n=e.AgentUtils.getAgentInfo();if(n.browser===e.AgentUtils.BROWSER.SAFARI||n.browser===e.AgentUtils.BROWSER.IE){var i=[];if(P(r)){var o=S(r);o.rejected.length>0&&(i=F(o.rejected))}else i.push({severity:"error",summary:p.defSingleFileUploadError});i.length>0&&(s=!1,U(i,t,!1))}s&&C(r,t),x(t)}}function F(e){var t=[];return 1===e.length?t.push({severity:"error",summary:r.getTranslatedString("oj-ojFilePicker.singleFileTypeUploadError",{fileType:e[0]})}):t.push({severity:"error",summary:r.getTranslatedString("oj-ojFilePicker.multipleFileTypeUploadError",{fileTypes:e.join(r.getTranslatedString("oj-converter.plural-separator"))})}),t}function U(e,t,r){r&&a.addClass("oj-invalid-drop");var n=r?new Promise(function(e){c=e}):null,i=new CustomEvent("ojInvalidSelect",{detail:{messages:e,originalEvent:t,until:n}});u.dispatchEvent(i)}function w(e){for(var t={length:{value:e.length},item:{value:function(e){return this[e]}}},r=0;r<e.length;r++)t[r]={value:e[r],enumerable:!0};return Object.create(FileList.prototype,t)}function C(e,t){var r=w(e),n=Promise.resolve(),i=new CustomEvent("ojBeforeSelect",{detail:{files:r,originalEvent:t,accept:function(e){n=e}}});u.dispatchEvent(i),n.then(function(){var e=new CustomEvent("ojSelect",{detail:{files:r,originalEvent:t}});u.dispatchEvent(e)},function(e){U(e,t,!1)})}p.acceptStr=n.pureComputed(function(){var e=v.accept;return e&&e.length?e.join(","):null},p),u.addEventListener("selectOnChanged",function(e){m(e.detail.value)}),u.addEventListener("disabledChanged",function(e){h(e.detail.value)}),p.defSingleFileUploadError=r.getTranslatedString("oj-ojFilePicker.singleFileUploadError"),p.defPrimaryDropzoneText=r.getTranslatedString("oj-ojFilePicker.dropzonePrimaryText"),p.defSecondaryDropzoneText=n.pureComputed(function(){return"single"===v.selectionMode?r.getTranslatedString("oj-ojFilePicker.secondaryDropzoneText"):r.getTranslatedString("oj-ojFilePicker.secondaryDropzoneTextMultiple")},p),p.defUnknownFileType=r.getTranslatedString("oj-ojFilePicker.unknownFileType"),p.bindingsApplied=function(){var r=t(u);r.addClass("oj-filepicker"),o=r;var n=r.find(".oj-filepicker-dropzone");a=n.length>0?n:o,m(v.selectOn);var i=r.find("input");i.length&&(d=i[0]).addEventListener("change",E,!1),h(g),g||(a[0].addEventListener("focus",function(){f||(e.DomUtils.recentPointer()?a.removeClass("oj-focus-highlight"):a.addClass("oj-focus-highlight"))}),a[0].addEventListener("focusout",function(){f||a.removeClass("oj-focus-highlight")}))}},metadata:a})});