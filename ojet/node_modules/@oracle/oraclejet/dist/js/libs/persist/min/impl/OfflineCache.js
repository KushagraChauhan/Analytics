define(["./defaultCacheHandler","../persistenceStoreManager","../persistenceUtils","./logger"],function(a,b,c,d){"use strict";function e(a,b){if(!a)throw TypeError("A name must be provided to create an OfflineCache!");if(!b)throw TypeError("A persistence store must be provided to create an OfflineCache!");this._name=a,this._storeName=b,this._store=null}function f(a,b,c){if(c&&c.length)for(var d=0;d<c.length;d++){var e=c[d];if(i(a,b,e))return e.responseData}return null}function g(a,b,c){var d=[];if(c&&c.length){var e=c.filter(h(a,b));d=e.map(function(a){return a.responseData})}return d}function h(a,b,c){return function(d){var e;return e=c?d[c]:d,i(a,b,e)}}function i(a,b,c){if(a)return!0;if(!c||!b)return!1;var e=c.requestData.headers,f=c.responseData.headers,g=b.headers,h=f.vary;if(d.log("Offline Persistence Toolkit OfflineCache: Processing HTTP Vary header"),!h)return!0;if("*"===h.trim())return!1;for(var i=h.split(","),j=0;j<i.length;j++){var k=i[j].toLowerCase();k=k.trim();var l=g.get(k),m=e[k];if(d.log("Offline Persistence Toolkit OfflineCache: HTTP Vary header name: "+k),d.log("Offline Persistence Toolkit OfflineCache: Request HTTP Vary header value: "+l),d.log("Offline Persistence Toolkit OfflineCache: Cached HTTP Vary header value: "+m),!(!m&&!l||m&&l&&m===l))return!1}return!0}function j(b){if(b){d.log("Offline Persistence Toolkit OfflineCache: Converting cached entry to Response object");var c=[],e=b.bodyAbstract;return e?(c.push(Promise.resolve(JSON.parse(e))),delete b.bodyAbstract):c.push(Promise.resolve()),c.push(a.constructResponse(b)),Promise.all(c)}return Promise.resolve()}function k(a){if(a&&a.length){var b=a.map(function(a){return j(a)});return Promise.all(b)}return Promise.resolve()}function l(a){var b=a.map(function(a){return{name:a.name,keys:a.keys?a.keys.reduce(function(a,b){return b?a.push(b.toString()):d.warn("should not have undefined key in the shredded data"),a},[]):a.keys,resourceType:a.resourceType}});return JSON.stringify(b)}function m(b,c,d){if(c){var e=a.constructSearchCriteria(c,d);e.fields=["key","value"];var f=d&&d.ignoreVary;return b.find(e).then(function(a){if(a&&a.length){var b=a.filter(h(f,c,"value")),d=b.map(function(a){return a.key});return d}return[]})}return b.keys()}return e.prototype.getName=function(){return this._name},e.prototype.add=function(a){d.log("Offline Persistence Toolkit OfflineCache: add()");var b=this;return fetch(a).then(function(c){var d=c.clone();return b.put(a,c).then(function(){Promise.resolve(d)})})},e.prototype.addAll=function(a){d.log("Offline Persistence Toolkit OfflineCache: addAll()");var b=a.map(this.add,this);return Promise.all(b)},e.prototype.match=function(b,c){d.log("Offline Persistence Toolkit OfflineCache: match() for Request with url: "+b.url);var e=this,g=a.constructSearchCriteria(b,c),h=c&&c.ignoreVary;return e._getStore().then(function(a){return a.find(g)}).then(function(a){var c=f(h,b,a);return j(c)}).then(function(c){if(c){var d=c[0],e=c[1];return a.fillResponseBodyWithShreddedData(b,d,e)}return Promise.resolve()})},e.prototype.matchAll=function(b,c){d.log("Offline Persistence Toolkit OfflineCache: matchAll() for Request with url: "+b.url);var e=this,f=a.constructSearchCriteria(b,c),h=c&&c.ignoreVary;return e._getStore().then(function(a){return a.find(f)}).then(function(a){var c=g(h,b,a);return k(c)}).then(function(c){if(c&&c.length){var d=c.map(function(c){var d=c[0],e=c[1];return a.fillResponseBodyWithShreddedData(b,d,e)});return Promise.all(d)}return Promise.resolve([])})},e.prototype._getStore=function(){var a=this;return a._store?Promise.resolve(a._store):b.openStore(a._storeName).then(function(b){return a._store=b,a._store})},e.prototype.put=function(b,c){d.log("Offline Persistence Toolkit OfflineCache: put() for Request with url: "+b.url);var e=this,f=[];return f.push(a.constructRequestResponseCacheData(b,c)),f.push(a.shredResponse(b,c)),Promise.all(f).then(function(b){return e._getStore().then(function(c){var d=b[0],e=b[1];if(e){var f=[];return d.value.responseData.bodyAbstract=l(e),f.push(c.upsert(d.key,d.metadata,d.value)),f.push(a.cacheShreddedData(e)),Promise.all(f)}return c.upsert(d.key,d.metadata,d.value)})})},e.prototype.delete=function(b,c){if(!b)return d.warn("Offline Persistence Toolkit OfflineCache: delete() request is a required parameter. To clear the cache, please call clear()"),Promise.resolve(!1);d.log("Offline Persistence Toolkit OfflineCache: delete() for Request with url: "+b.url);var e=this;if(a.hasShredder(b)){var f=a.constructSearchCriteria(b,c);f.fields=["key","value"];var g,i=c&&c.ignoreVary;return e._getStore().then(function(a){return g=a,g.find(f)}).then(function(c){if(c&&c.length){var e=c.filter(h(i,b,"value")),f=[];return e.forEach(function(b){f.push(g.removeByKey(b.key)),b.value.responseData.bodyAbstract&&b.value.responseData.bodyAbstract.length&&f.push(a.deleteShreddedData(JSON.parse(b.value.responseData.bodyAbstract)))}),Promise.all(f).then(function(){return d.log("Offline Persistence Toolkit OfflineCache: all matching entries are deleted from both the cache store and the shredded store."),!0}).catch(function(a){return d.log("Offline Persistence Toolkit OfflineCache: error occurred when deleting matched cache entries."),!1})}return d.log("Offline Persistence Toolkit OfflineCache: no matching entries are found from the cache."),!1})}return e._getStore().then(function(a){return m(a,b,c).then(function(b){if(b&&b.length){var c=b.map(a.removeByKey,a);return Promise.all(c)}return!1})}).then(function(a){return!(!a||!a.length)})},e.prototype.keys=function(a,b){a?d.log("Offline Persistence Toolkit OfflineCache: keys() for Request with url: "+a.url):d.log("Offline Persistence Toolkit OfflineCache: keys()");return this._getStore().then(function(d){return m(d,a,b).then(function(a){var b=[];return a.forEach(function(a){b.push(d.findByKey(a).then(function(a){return c.requestFromJSON(a.requestData)}))}),Promise.all(b)})})},e.prototype.hasMatch=function(b,c){d.log("Offline Persistence Toolkit OfflineCache: hasMatch() for Request with url: "+b.url);var e=this,g=a.constructSearchCriteria(b,c),h=c&&c.ignoreVary;return e._getStore().then(function(a){return a.find(g).then(function(a){var c=f(h,b,a);return null!==c})})},e.prototype.clear=function(){d.log("Offline Persistence Toolkit OfflineCache: clear()");var a=this,b=[];return this.keys().then(function(c){return c.forEach(function(c,d,e){b.push(a.delete(c))}),Promise.all(b)}).then(function(a){var b=!1;return a.forEach(function(a){a||(b=!0)}),!b})},e});