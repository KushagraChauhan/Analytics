define(["./persistenceManager","./persistenceStoreManager","./persistenceUtils","./impl/logger","./impl/sql-where-parser.min"],function(a,b,c,d,e){"use strict";function f(a,b,e){return b=b||function(a){return h(a,null)},function(f,h){if("GET"==f.method||"HEAD"==f.method){d.log("Offline Persistence Toolkit queryHandlers: OracleRestQueryHandler processing request");var i,j,l=f.url.split("?"),m={};j="undefined"==typeof URLSearchParams?k(l[1]):new URLSearchParams(l[1]).entries();var n,o,p,q,r;do n=j.next(),null!=n.value&&(o=n.value[0],p=n.value[1],"q"==o?i=p:"limit"==o?q=p:"offset"==o&&(r=p));while(!n.done);var s,t,m=c._mapFindQuery(b(i),e);if(null!=h.jsonProcessor&&(s=h.jsonProcessor.shredder,t=h.jsonProcessor.unshredder),null!=s&&null!=t)return g(f,a,m,s,t,r,q).then(function(a){if(!a)return Promise.resolve();var b=a.clone();return b.text().then(function(b){if(null!=b&&b.length>0)try{var d=JSON.parse(b);return d.links?Promise.resolve(a):(d.links=[{rel:"self",href:f.url}],c.setResponsePayload(a,d).then(function(a){return Promise.resolve(a)}))}catch(a){}})})}return Promise.resolve()}}function g(d,e,f,g,h,i,j){return a.getCache().hasMatch(d,{ignoreSearch:!0}).then(function(k){return b.openStore(e).then(function(b){if(k)return a.getCache().match(d,{ignoreSearch:!0}).then(function(a){return"single"===a.headers.get("x-oracle-jscpt-resource-type")?Promise.resolve():b.find(f)});var c=m(d);return c?b.findByKey(c):Promise.resolve([])}).then(function(b){return a.getCache().match(d,{ignoreSearch:!0}).then(function(f){if(f){var k=!1,l=0;return b&&(l=b.length,i&&i>0&&(k=i<b.length,b=b.slice(i,b.length)),j&&j>0&&(k=j<=b.length,b=b.slice(0,j))),g(f).then(function(a){var d=a[0].resourceType,g={name:e,data:null!=b?b:a[0].data,resourceType:d};return h([g],f).then(function(a){var b=a.clone();return b.text().then(function(b){if(!(null!=b&&b.length>0))return a;try{var d=JSON.parse(b);return null!=d.items&&(j&&(d.limit=parseInt(j,10)),i&&(d.offset=parseInt(i,10)),d.hasMore=k,d.totalResults=l),c.setResponsePayload(a,d)}catch(a){}})})})}if(b&&Object.keys(b).length>0){var m=n(d);return m?c.requestToJSON(d).then(function(d){return d.url=m,c.requestFromJSON(d).then(function(c){return a.getCache().match(c,{ignoreSearch:!0}).then(function(a){if(a){var c={name:e,data:[b],resourceType:"single"};return h([c],a)}})})}):Promise.resolve()}return Promise.resolve()})})})}function h(a){var b={};if(a){var c,d=new e,f=a.split(";"),g={},h=[],i={};for(c=0;c<f.length;c++)i=d.parse(f[c],function(a,b){a=a.toUpperCase(),"AND"!=a&&"OR"!=a&&(b[0]="value."+b[0]);var c=b[0],d=b[1],e={};switch(a){case">":e[c]={$gt:d};break;case"<":e[c]={$lt:d};break;case">=":e[c]={$gte:d};break;case"<=":e[c]={$lte:d};break;case"=":e[c]={$eq:d};break;case"!=":e[c]={$ne:d};break;case"AND":e={$and:b};break;case"OR":e={$or:b};break;case"LIKE":d=d.replace("%",".+"),e[c]={$regex:d};break;case"BETWEEN":var f=[];f[0]={},f[1]={},f[0][c]={$gte:b[1]},f[1][c]={$lte:b[2]},e={$and:f}}return e}),h.push(i);h.length>1?g.$and=h:1==h.length&&(g=h[0]),Object.keys(g).length>0&&(b.selector=g)}return b}function i(a,b,e){return function(f,h){if("GET"==f.method||"HEAD"==f.method){d.log("Offline Persistence Toolkit queryHandlers: SimpleQueryHandler processing request");var i,k,l=f.url.split("?"),m=c._mapFindQuery(j(l,b),e);if(null!=h.jsonProcessor&&(i=h.jsonProcessor.shredder,k=h.jsonProcessor.unshredder),null!=i&&null!=k)return g(f,a,m,i,k)}return Promise.resolve()}}function j(a,b){var c={};if(a&&a.length>1){var d,e={};d="undefined"==typeof URLSearchParams?k(a[1]):new URLSearchParams(a[1]).entries();var f,g,h;do f=d.next(),null!=f.value&&(g=f.value[0],h=f.value[1],b&&b.indexOf(g)!=-1||(e["value."+g]=h));while(!f.done);Object.keys(e).length>0&&(c.selector=e)}return c}function k(a){var b=[];if(null!=a){"?"===a.charAt(0)&&(a=a.slice(1)),a=a||"";var c,d,e,f=a.split("&");b=f.map(function(a){return e=a.indexOf("="),e>-1?(c=a.slice(0,e),d=a.slice(e+1),d=l(d)):(c=a,d=""),c=l(c),[c,d]})}var g={next:function(){var a=b.shift();return{done:void 0===a,value:a}}};return g}function l(a){return decodeURIComponent(a.replace(/\+/g," "))}function m(a){var b=a.url.split("/");return b.length>1?b[b.length-1].split("?")[0]:null}function n(a){var b=a.url.split("/");return b.length>1?(b.pop(),b.join("/")):null}return{getSimpleQueryHandler:i,getOracleRestQueryHandler:f}});